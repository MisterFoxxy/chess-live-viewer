<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf‑8">
  <title>Live‑шахматы</title>

  <!-- стили доски chessground -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/chessground@8.2.7/dist/chessground.css"/>

  <style>
    body{margin:0;font-family:sans-serif;background:#f4f4f4}
    #boards{display:flex;flex-wrap:wrap;justify-content:center}
    .board{width:320px;height:380px;margin:1rem;background:#fff;
           border-radius:8px;box-shadow:0 0 6px rgba(0,0,0,.1);position:relative}
    .name{padding:.3rem .5rem;text-align:center;background:#fff;
          border-bottom:1px solid #e5e5e5;font-weight:600}
    .cg-wrap{width:100%;height:calc(100% - 32px)}
  </style>
</head>

<body>
  <div id="boards"></div>

  <!-- UMD‑сборка chessground (без “export”) -->
  <script src="https://cdn.jsdelivr.net/npm/chessground@8.2.7/dist/chessground.min.js"></script>
  <!-- chess.js – удобно парсить PGN -->
  <script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0-beta.1/dist/chess.min.js"></script>

  <script>
  /***********  НАСТРОЙКИ  *********************************************/
  const PGN_URL    = 'https://pgn-bridge.zerarfernando.workers.dev/pgn'; // Cloudflare‑worker
  const REFRESH_MS = 5_000;                                             // период обновл. (мс)
  /*********************************************************************/

  const boardsDiv = document.getElementById('boards');
  const boards = [];   // {ground, wrapper}

  function createBoard() {
    const w = document.createElement('div'); w.className = 'board';
    const bar = document.createElement('div'); bar.className = 'name';  w.appendChild(bar);
    const cg  = document.createElement('div'); cg.className  = 'cg-wrap'; w.appendChild(cg);
    boardsDiv.appendChild(w);
    return {ground: Chessground(cg,{viewOnly:true,resizable:true,coordinates:false}),
            wrapper: w};
  }

  function render(games){
    while (boards.length < games.length) boards.push(createBoard());

    games.forEach((g,i)=>{
      const {ground,wrapper} = boards[i];
      wrapper.querySelector('.name').textContent = `${g.white} – ${g.black}`;

      const chess = new Chess();
      g.moves.forEach(m=> chess.move(m));
      ground.set({fen: chess.fen()});      // позиция после последнего хода
    });
  }

  function parsePGN(pgn){
    return pgn
      .split(/\n\n(?=\[Event|\[Site|\[White)/).filter(Boolean)
      .map(block=>{
        const white = (block.match(/\[White \"([^\"]+)\"/m)||['?','?'])[1];
        const black = (block.match(/\[Black \"([^\"]+)\"/m)||['?','?'])[1];
        const moves = block
          .replace(/\[.*\]\s*/g,'')        // убрать теги
          .replace(/\{[^}]+\}/g,'')        // комментарии
          .replace(/\d+\.(\.\.)?/g,'')     // номера ходов
          .trim().split(/\s+/)
          .filter(s=>!s.match(/^(1-0|0-1|1\/2-1\/2|\*)$/));
        return {white,black,moves};
      });
  }

  async function update(){
    try{
      const txt = await (await fetch(PGN_URL + '?t=' + Date.now())).text();
      render(parsePGN(txt));
    }catch(e){ console.error(e); }
    setTimeout(update, REFRESH_MS);
  }
  update();
  </script>
</body>
</html>
