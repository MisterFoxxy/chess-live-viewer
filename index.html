<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Шахматные партии</title>
<style>
  /* Chessground base and theme (pieces, etc) CSS */
  .cg-wrap {
    width: 320px;
    height: 320px;
    position: relative;
    display: block;
  }
  cg-helper {
    position: absolute;
    width: 12.5%;
    padding-bottom: 12.5%;
    display: table;
    bottom: 0;
  }
  cg-container {
    position: absolute;
    width: 800%;
    height: 800%;
    display: block;
    bottom: 0;
  }
  cg-board {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    line-height: 0;
    background-size: cover;
    cursor: pointer;
    /* Checkerboard pattern for board squares */
    background-color: #f0d9b5;
    background-image: linear-gradient(45deg,
      #f0d9b5 25%, #b58863 25%, #b58863 50%,
      #f0d9b5 50%, #f0d9b5 75%, #b58863 75%, #b58863 100%);
    background-size: 40px 40px;
  }
  cg-board square {
    position: absolute;
    top: 0;
    left: 0;
    width: 12.5%;
    height: 12.5%;
    pointer-events: none;
  }
  cg-board square.move-dest {
    background: radial-gradient(rgba(20,85,30,0.5) 22%, #208530 0, rgba(0,0,0,0.3) 0, rgba(0,0,0,0) 0);
    pointer-events: auto;
  }
  cg-board square.premove-dest {
    background: radial-gradient(rgba(20,30,85,0.5) 22%, #203085 0, rgba(0,0,0,0.3) 0, rgba(0,0,0,0) 0);
  }
  cg-board square.oc.move-dest {
    background: radial-gradient(transparent 0%, transparent 80%, rgba(20,85,0,0.3) 80%);
  }
  cg-board square.oc.premove-dest {
    background: radial-gradient(transparent 0%, transparent 80%, rgba(20,30,85,0.2) 80%);
  }
  cg-board square.move-dest:hover {
    background: rgba(20,85,30,0.3);
  }
  cg-board square.premove-dest:hover {
    background: rgba(20,30,85,0.2);
  }
  cg-board square.last-move {
    will-change: transform;
    background-color: rgba(155,199,0,0.41);
  }
  cg-board square.selected {
    background-color: rgba(20,85,30,0.5);
  }
  cg-board square.check {
    background: radial-gradient(ellipse at center, rgba(255,0,0,1) 0%, rgba(231,0,0,1) 25%, rgba(169,0,0,0) 89%, rgba(158,0,0,0) 100%);
  }
  cg-board square.current-premove {
    background-color: rgba(20,30,85,0.5);
  }
  .cg-wrap piece {
    position: absolute;
    top: 0;
    left: 0;
    width: 12.5%;
    height: 12.5%;
    background-size: cover;
    z-index: 2;
    will-change: transform;
    pointer-events: none;
  }
  cg-board piece.dragging {
    cursor: move;
    z-index: 9;
  }
  cg-board piece.anim {
    z-index: 8;
  }
  cg-board piece.fading {
    z-index: 1;
    opacity: 0.5;
  }
  .cg-wrap piece.ghost {
    opacity: 0.3;
  }
  .cg-wrap svg {
    overflow: hidden;
    position: relative;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 2;
    opacity: 0.6;
  }
  .cg-wrap svg image {
    opacity: 0.5;
  }

  /* Layout and text styling */
  body { font-family: Arial, sans-serif; margin: 20px; }
  .boards {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
  }
  .board-container {
    text-align: center;
  }
  .players {
    font-weight: bold;
    margin-bottom: 4px;
  }
</style>
</head>
<body>
<div id="boards" class="boards"></div>

<!-- External libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessground/9.1.1/chessground.min.js" integrity="sha512-PeqprLAuTmEx5wHKdYTHPoFLaMLRszp4YLtXIwT7oseCWeTLT3KQnGD2KJ0ZB9GPlAucFfSAIAJC3kPp/wLw/g==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js" integrity="sha512-5I95HUXTi36QXD3UrqpAIiMn31QU9sv+f5vXaYtZbBt7d+wXwYtm3J7q0hmN4b6gRDQePrOKSWaaO8JV+LM/BA==" crossorigin="anonymous"></script>

<script>
  const boardsContainer = document.getElementById('boards');
  let boardInstances = [];

  function parsePGN(pgnText) {
    const games = pgnText.trim().split(/\r?\n\s*\r?\n/);
    const result = [];
    for (let gameText of games) {
      if (!gameText.trim()) continue;
      // Extract PGN tags
      const tagLines = gameText.match(/\[.*?\]/g) || [];
      const tags = {};
      for (let line of tagLines) {
        const match = line.match(/^\[(\w+)\s+"([^"]*)"\]$/);
        if (match) {
          tags[match[1]] = match[2];
        }
      }
      // Use chess.js to get final FEN
      const chess = new Chess();
      chess.load_pgn(gameText);
      result.push({
        white: tags.White || "?",
        black: tags.Black || "?",
        boardNum: tags.Board ? tags.Board.trim() : "",
        result: tags.Result || "",
        fen: chess.fen()
      });
    }
    return result;
  }

  function updateBoards(games) {
    games.forEach((game, i) => {
      if (!boardInstances[i]) {
        // Create elements for new board
        const containerDiv = document.createElement('div');
        containerDiv.className = 'board-container';
        const playersDiv = document.createElement('div');
        playersDiv.className = 'players';
        playersDiv.textContent = `${game.white} (белые) — ${game.black} (чёрные)`;
        const boardDiv = document.createElement('div');
        boardDiv.id = 'board' + i;
        boardDiv.className = 'cg-wrap';
        containerDiv.appendChild(playersDiv);
        containerDiv.appendChild(boardDiv);
        boardsContainer.appendChild(containerDiv);
        // Initialize chessboard
        boardInstances[i] = Chessground(boardDiv, { fen: game.fen, coordinates: false });
      } else {
        // Update existing board
        const containerDiv = document.getElementById('board' + i).parentNode;
        containerDiv.querySelector('.players').textContent = `${game.white} (белые) — ${game.black} (чёрные)`;
        boardInstances[i].set({ fen: game.fen });
      }
    });
    // Remove any extra boards if games list shrunk
    for (let j = games.length; j < boardInstances.length; j++) {
      const boardElem = document.getElementById('board' + j);
      if (boardElem) {
        boardsContainer.removeChild(boardElem.parentNode);
      }
    }
    boardInstances = boardInstances.slice(0, games.length);
  }

  async function fetchAndUpdate() {
    try {
      const response = await fetch('https://pgn-bridge.zerarfernando.workers.dev/pgn', { cache: 'no-cache' });
      if (!response.ok) return;
      const pgnText = await response.text();
      const games = parsePGN(pgnText);
      updateBoards(games);
    } catch (e) {
      console.error('Ошибка при получении PGN:', e);
    }
  }

  // Initial load and periodic update
  fetchAndUpdate();
  setInterval(fetchAndUpdate, 5000);
</script>
</body>
</html>
