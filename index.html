<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf‑8">
  <title>Live‑шахматы</title>

  <!-- chess‑ground и chess.js БЕЗ integrity, чтобы браузер не блокировал -->
  <link  href="https://cdnjs.cloudflare.com/ajax/libs/chessground/9.1.1/chessground.css"  rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessground/9.1.1/chessground.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>

  <style>
    body{margin:0;font-family:sans-serif;background:#f5f5f5}
    #boards{display:flex;flex-wrap:wrap;justify-content:center}
    .board{width:340px;margin:1rem;background:#fff;
           border-radius:8px;box-shadow:0 0 6px rgba(0,0,0,.1)}
    .name{padding:.4rem;text-align:center;font-weight:600;border-bottom:1px solid #eee}
    .cg-wrap{width:340px;height:340px}
  </style>
</head>
<body>
  <div id="boards"></div>

<script>
/* ---------- НАСТРОЙКИ ---------- */
const PGN_URL    = 'https://pgn-bridge.zerarfernando.workers.dev/pgn';
const REFRESH_MS = 5_000;
const PIECE_CDN  = 'https://cdn.jsdelivr.net/gh/lichess-org/lila@master/public/piece/alpha/60/';
/* --------------------------------*/

const boardsDiv = document.getElementById('boards');
const boards = [];

function createBoard(){
  const wrap = document.createElement('div'); wrap.className='board';
  const title= document.createElement('div'); title.className='name'; wrap.appendChild(title);
  const cgDiv= document.createElement('div'); cgDiv.className='cg-wrap'; wrap.appendChild(cgDiv);
  boardsDiv.appendChild(wrap);

  const ground = Chessground(cgDiv,{
    viewOnly:true,
    resizable:true,
    sprite: { url: PIECE_CDN+'wp.png',  // любую существующую картинку из набора
              size: 60,  cache: false } // cache=false → при смене CDN сразу видно результат
  });

  return {ground,title};
}

function render(games){
  while(boards.length < games.length) boards.push(createBoard());
  games.forEach((g,i)=>{
    const {ground,title} = boards[i];
    title.textContent = `${g.white} — ${g.black}`;
    const chess = new Chess();
    g.moves.forEach(m=>chess.move(m));
    ground.set({fen: chess.fen()});
  });
}

function parsePGN(pgn){
  return pgn
    .split(/\n\n(?=\[Event)/).filter(Boolean)
    .map(block=>{
      const tag = key=> (block.match(new RegExp(`\\[${key} "([^"]+)"`))||[])[1]||'?';
      const moves = block
        .replace(/\[.*]/g,'')
        .replace(/\{[^}]*}/g,'')
        .replace(/\d+\.(\.\.)?/g,'')
        .trim().split(/\s+/)
        .filter(x=>!/^1-0|0-1|1\/2-1\/2|\*$/.test(x));
      return {white:tag('White'), black:tag('Black'), moves};
    });
}

async function fetchAndUpdate(){
  try{
    const txt = await fetch(PGN_URL + '?t=' + Date.now()).then(r=>r.text());
    render(parsePGN(txt));
  }catch(e){ console.error('Ошибка при получении PGN:',e); }
  setTimeout(fetchAndUpdate, REFRESH_MS);
}
fetchAndUpdate();
</script>
</body>
</html>
