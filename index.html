<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf‑8">
  <title>Live‑шахматы</title>

  <!-- Chessground 7.9.3 (UMD) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/chessground/7.9.3/chessground.min.css" rel="stylesheet">

  <style>
    body   {margin:0;font-family:sans-serif;background:#f4f4f4}
    #boards{display:flex;flex-wrap:wrap;justify-content:center;padding:1rem}

    .board{width:320px;height:380px;margin:1rem;background:#fff;
           border-radius:8px;box-shadow:0 0 6px rgba(0,0,0,.1);position:relative}

    .name {padding:.35rem .5rem;text-align:center;background:#fff;
           border-bottom:1px solid #e5e5e5;font-weight:600;font-size:14px}

    .cg-wrap{width:100%;height:calc(100% - 34px)}
  </style>
</head>

<body>
  <div id="boards"></div>

  <!-- библиотеки без integrity / modules -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessground/7.9.3/chessground.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>

  <script>
  /* === НАСТРОЙКИ =================================================== */
  const PGN_URL    = 'https://pgn-bridge.zerarfernando.workers.dev/pgn'; // live‑PGN
  const REFRESH_MS = 5000;                                              // период опроса
  /* ================================================================= */

  const boardsDiv = document.getElementById('boards');
  const boards    = [];                    // {ground, wrapper}

  function createBoard() {
    const wrapper = document.createElement('div'); wrapper.className = 'board';

    const header  = document.createElement('div'); header.className  = 'name';
    wrapper.appendChild(header);

    const cgBox   = document.createElement('div'); cgBox.className   = 'cg-wrap';
    wrapper.appendChild(cgBox);

    boardsDiv.appendChild(wrapper);

    const ground = Chessground(cgBox, {
      viewOnly    : true,
      resizable   : true,
      coordinates : false
    });

    return {ground, wrapper};
  }

  function render(games) {
    while (boards.length < games.length) boards.push(createBoard());

    games.forEach((g, i) => {
      const {ground, wrapper} = boards[i];
      wrapper.querySelector('.name').textContent = `${g.white} – ${g.black}`;

      const chess = new Chess();
      g.moves.forEach(m => chess.move(m));
      ground.set({fen: chess.fen()});        // позиция после последнего хода
    });
  }

  function parsePGN(pgn) {
    return pgn
      .split(/\n\n(?=\[Event|\[Site|\[White)/).filter(Boolean)
      .map(block => {
        const white = (block.match(/\[White \"([^\"]+)\"/) || [, '?'])[1];
        const black = (block.match(/\[Black \"([^\"]+)\"/) || [, '?'])[1];

        const moves = block
          .replace(/\[.*\]\s*/g, '')         // теги
          .replace(/\{[^}]+\}/g, '')         // комментарии
          .replace(/\d+\.(\.\.)?/g, '')      // номера ходов
          .trim().split(/\s+/)
          .filter(t => !t.match(/^(1-0|0-1|1\/2-1\/2|\*)$/));

        return {white, black, moves};
      });
  }

  async function fetchAndUpdate() {
    try {
      const txt   = await (await fetch(PGN_URL + '?t=' + Date.now())).text();
      const games = parsePGN(txt);
      render(games);
    } catch (e) {
      console.error('Ошибка при получении PGN:', e);
    } finally {
      setTimeout(fetchAndUpdate, REFRESH_MS);
    }
  }

  fetchAndUpdate();
  </script>
</body>
</html>
