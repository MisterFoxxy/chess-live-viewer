<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Live‑шахматы</title>

<!-- Стили доски Chessground -->
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/chessground@9.0.4/dist/chessground.base.css">

<style>
  body{margin:0;font-family:sans-serif;background:#f4f4f4}
  .board{width:320px;height:320px;margin:1rem;float:left;
         border-radius:8px;box-shadow:0 0 6px rgba(0,0,0,.1)}
  .name{padding:.3rem .5rem;text-align:center;background:#fff;
        border-bottom:1px solid #e5e5e5}
</style>
</head>
<body>
  <div id="boards"></div>

  <!-- Библиотеки -->
  <script src="https://cdn.jsdelivr.net/npm/chessground@9.0.4/dist/chessground.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/dist/chess.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mliebelt/pgn-parser@1.6.1/dist/pgn-parser.min.js"></script>

  <script>
  // ===  Настройки  ==========================================================
  // Адрес вашего Cloudflare Worker'а, который отдаёт PGN‑поток
  const BRIDGE_URL = 'https://pgn-bridge.zerarfernando.workers.dev/pgn';
  // Период опроса (мс)
  const POLL_MS   = 3000;
  // ==========================================================================

  const root    = document.getElementById('boards');
  const grounds = new Map();        // boardNo → Chessground

  // Разбор потока PGN‑Live
  function parsePGN(txt){
    // PGN‑Live склеивает партии без переноса строк → добавляем их сами
    const raw = txt.trim().replace(/\s+\[/g, '\n[')
                         .split('\n[').map(s => '[' + s);
    return raw.map(pgn => {
      const data = window.pgnParser.parse(pgn)[0];
      return {
        board : +data.tags.Board || 0,
        white : data.tags.White  || '?',
        black : data.tags.Black  || '?',
        moves : data.moves.map(m => m.notation.notation)
      };
    });
  }

  // Показываем / обновляем доски
  function renderBoards(games){
    games.forEach(g => {
      // создаём контейнер и доску, если их ещё нет
      if(!grounds.has(g.board)){
        const wrap = document.createElement('div');
        wrap.className = 'board';
        wrap.innerHTML =
          `<div class="name">${g.white} – ${g.black}</div>
           <div id="cg${g.board}"></div>`;
        root.appendChild(wrap);
        const cg = Chessground(document.getElementById(`cg${g.board}`),
                               {viewOnly:true});
        grounds.set(g.board, cg);
      }

      // рассчитываем позицию после всех ходов
      const chess = new window.Chess();
      g.moves.forEach(m => chess.move(m));
      grounds.get(g.board).set({fen: chess.fen()});

      // обновляем фамилии (мало ли изменятся)
      const wrap = grounds.get(g.board).container.parentNode;
      wrap.querySelector('.name').textContent = `${g.white} – ${g.black}`;
    });
  }

  // Периодически тянем PGN с Worker'а
  async function load(){
    try{
      const txt = await fetch(`${BRIDGE_URL}?${Date.now()}`, {cache:'no-store'})
                         .then(r => r.text());
      renderBoards(parsePGN(txt));
    }catch(e){
      console.error('Ошибка загрузки PGN:', e);
    }
  }
  load();                       // первая загрузка сразу
  setInterval(load, POLL_MS);   // затем — каждые POLL_MS
  </script>
</body>
</html>
