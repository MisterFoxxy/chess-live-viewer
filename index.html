<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Live‑шахматы</title>

  <!-- ─── СТИЛЬ ДОСКИ chessground ──────────────────────────────────────────── -->
  <!-- ⚠️  Берём «старую» UMD‑версию (7.9.3): она отдает глобальный   -->
  <!--     объект Chessground без import/export, поэтому работает в   -->
  <!--     любом браузере и на GitHub Pages без сборщиков.            -->
  <link  href="https://cdnjs.cloudflare.com/ajax/libs/chessground/7.9.3/chessground.min.css"
         rel="stylesheet">
  <style>
    /* упрощённые стили макета */
    *{box-sizing:border-box}  body{margin:0;background:#f4f4f4;font-family:sans-serif}
    #boards{display:flex;flex-wrap:wrap;justify-content:center;padding:1rem}
    .card   {width:320px;margin:1rem;border-radius:8px;box-shadow:0 0 6px rgba(0,0,0,.1);background:#fff}
    .title  {padding:.4rem .6rem;font-weight:600;text-align:center;border-bottom:1px solid #e5e5e5}
    .cg-wrap{width:100%;height:320px}       /* доска 8×8 = квадрат */
  </style>
</head>
<body>
  <div id="boards"></div>

  <!-- ─── СКРИПТЫ ──────────────────────────────────────────────────────────── -->
  <!-- chessground UMD                                                       -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessground/7.9.3/chessground.min.js"></script>
  <!-- chess.js (глобальный объект Chess)                                    -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>

  <script>
  /* --------------------------------------------------------------------------
     КОНФИГ
  -------------------------------------------------------------------------- */
  const PGN_URL     = 'https://pgn-bridge.zerarfernando.workers.dev/pgn'; // твой worker
  const REFRESH_MS  = 5_000;                                             // обновление, мс
  /* ---------------------------------------------------------------------- */

  const host      = document.getElementById('boards');
  const boardPool = [];                        // переиспользуем карточки

  /* создаёт div.card с .title + контейнер для доски */
  function makeCard(){
    const card  = document.createElement('div'); card.className = 'card';
    const title = document.createElement('div'); title.className = 'title'; card.appendChild(title);
    const wrap  = document.createElement('div'); wrap.className  = 'cg-wrap'; card.appendChild(wrap);
    host.appendChild(card);

    const cg = Chessground(wrap,{viewOnly:true, coordinates:false});
    return {card, title, cg};
  }

  /* рисуем все партии */
  function render(games){
    // гарантируем нужное количество карточек
    while(boardPool.length < games.length) boardPool.push(makeCard());

    games.forEach((g,i)=>{
      const {title, cg} = boardPool[i];
      title.textContent = `${g.white} – ${g.black}`;

      const chess = new Chess();
      g.moves.forEach(m => chess.move(m));
      cg.set({fen: chess.fen()});                 // позиция после последнего хода
    });
  }

  /* парсим PGN‑файл в [{white,black,moves[]}, …] */
  function parsePGN(text){
    return text
      .split(/\n\n(?=\[Event)/).filter(Boolean)   // блоки по 1 партии
      .map(block=>{
        const tag = name => (block.match(new RegExp(`\\[${name} "([^"]+)"`))||[])[1] || '?';
        const white = tag('White'), black = tag('Black');

        const moveSection = block.replace(/\[.*\]\s*/g,'')        // теги
                                 .replace(/\{[^}]*\}/g,'')        // комментарии
                                 .replace(/\d+\.(\.\.)?/g,'')     // номера ходов
                                 .trim();
        const moves = moveSection.split(/\s+/)
                                 .filter(s=>!s.match(/^(1-0|0-1|1\/2-1\/2|\*)$/));
        return {white,black,moves};
      });
  }

  /* цикличное обновление */
  async function fetchAndUpdate(){
    try{
      const res  = await fetch(PGN_URL + '?t=' + Date.now());   // кеш‑бастер
      const pgn  = await res.text();
      const data = parsePGN(pgn);
      render(data);
    }catch(err){ console.error('Ошибка при получении PGN:', err); }
    setTimeout(fetchAndUpdate, REFRESH_MS);
  }
  fetchAndUpdate();
  </script>
</body>
</html>
