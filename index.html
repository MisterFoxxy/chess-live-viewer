<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Live‑шахматы</title>

  <!-- Стили chessground -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/chessground/9.1.1/chessground.min.css">

  <style>
    /* ---------- оформление карточек с досками ---------- */
    body{margin:0;font-family:sans-serif;background:#f4f4f4}
    #boards{display:flex;flex-wrap:wrap;justify-content:center;gap:2rem;padding:2rem}
    .board{width:340px;background:#fff;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,.08)}
    .board .name{padding:.5rem;text-align:center;font-weight:600;border-bottom:1px solid #e5e5e5}
    .board .cg-wrap{width:100%;aspect-ratio:1/1}      /* квадрат под доску */

    /* ---------- свои картинки фигур ---------- */
    .cg-piece{background-size:contain!important;background-repeat:no-repeat}

    /* белые */
    .cg-piece.white.king   {background-image:url("https://cdn.jsdelivr.net/gh/oakmac/chessboardjs/website/img/chesspieces/wikipedia/wK.png")}
    .cg-piece.white.queen  {background-image:url("https://cdn.jsdelivr.net/gh/oakmac/chessboardjs/website/img/chesspieces/wikipedia/wQ.png")}
    .cg-piece.white.rook   {background-image:url("https://cdn.jsdelivr.net/gh/oakmac/chessboardjs/website/img/chesspieces/wikipedia/wR.png")}
    .cg-piece.white.bishop {background-image:url("https://cdn.jsdelivr.net/gh/oakmac/chessboardjs/website/img/chesspieces/wikipedia/wB.png")}
    .cg-piece.white.knight {background-image:url("https://cdn.jsdelivr.net/gh/oakmac/chessboardjs/website/img/chesspieces/wikipedia/wN.png")}
    .cg-piece.white.pawn   {background-image:url("https://cdn.jsdelivr.net/gh/oakmac/chessboardjs/website/img/chesspieces/wikipedia/wP.png")}

    /* чёрные */
    .cg-piece.black.king   {background-image:url("https://cdn.jsdelivr.net/gh/oakmac/chessboardjs/website/img/chesspieces/wikipedia/bK.png")}
    .cg-piece.black.queen  {background-image:url("https://cdn.jsdelivr.net/gh/oakmac/chessboardjs/website/img/chesspieces/wikipedia/bQ.png")}
    .cg-piece.black.rook   {background-image:url("https://cdn.jsdelivr.net/gh/oakmac/chessboardjs/website/img/chesspieces/wikipedia/bR.png")}
    .cg-piece.black.bishop {background-image:url("https://cdn.jsdelivr.net/gh/oakmac/chessboardjs/website/img/chesspieces/wikipedia/bB.png")}
    .cg-piece.black.knight {background-image:url("https://cdn.jsdelivr.net/gh/oakmac/chessboardjs/website/img/chesspieces/wikipedia/bN.png")}
    .cg-piece.black.pawn   {background-image:url("https://cdn.jsdelivr.net/gh/oakmac/chessboardjs/website/img/chesspieces/wikipedia/bP.png")}
  </style>
</head>

<body>
  <div id="boards"></div>

  <!-- chessground и chess.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessground/9.1.1/chessground.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0-beta.1/chess.min.js"></script>

  <script>
  /***************** НАСТРОЙКИ ****************************/
  const PGN_URL    = 'https://pgn-bridge.zerarfernando.workers.dev/pgn'; // live‑PGN
  const REFRESH_MS = 5_000;                                             // интервал обновления
  /*******************************************************/

  const boardsDiv = document.getElementById('boards');
  const boards = [];      // массив {ground, wrapper}

  /* создаём карточку с доской */
  function createBoard() {
    const wrap = document.createElement('div');  wrap.className = 'board';
    const name = document.createElement('div');  name.className = 'name'; wrap.appendChild(name);
    const cgW  = document.createElement('div');  cgW.className  = 'cg-wrap'; wrap.appendChild(cgW);
    boardsDiv.appendChild(wrap);

    const ground = Chessground(cgW, {
      viewOnly:   true,
      coordinates:false,
      resizable:  true,
      animation:  {duration:200}
    });

    return {ground, wrapper:wrap};
  }

  /* рисуем все партии */
  function render(games){
    while (boards.length < games.length) boards.push(createBoard());

    games.forEach((g,i)=>{
      const {ground,wrapper} = boards[i];
      wrapper.querySelector('.name').textContent = `${g.white} — ${g.black}`;

      const chess = new Chess();
      g.moves.forEach(m => chess.move(m));
      ground.set({fen: chess.fen()});
    });
  }

  /* парсим PGN‑текст в [{white,black,moves[]}, …] */
  function parsePGN(pgn){
    return pgn
      .split(/\n\n(?=\[Event|\[Site|\[White|\[Black)/).filter(Boolean)
      .map(block=>{
        const tag = t => (block.match(new RegExp(`\\[${t} "([^"]+)"`))||[])[1]||'?';
        const moves = block
          .replace(/\[.*\]\s*/g,'')      // убрать теги
          .replace(/\{[^}]+\}/g,'')      // комменты
          .replace(/\d+\.(?:\s*\.\.)?/g,'') // номера ходов
          .trim().split(/\s+/)
          .filter(s=>!/^(1-0|0-1|1\/2-1\/2|\*)$/.test(s));

        return {white:tag('White'), black:tag('Black'), moves};
      });
  }

  /* циклическое обновление */
  async function fetchAndUpdate(){
    try{
      const res = await fetch(PGN_URL + '?t=' + Date.now());
      const txt = await res.text();
      render(parsePGN(txt));
    }catch(err){
      console.error('Ошибка при получении PGN:', err);
    }
    setTimeout(fetchAndUpdate, REFRESH_MS);
  }
  fetchAndUpdate();
  </script>
</body>
</html>
